{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pr√©diction d'Images - AI Energy</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Core CSS -->
  <link rel="stylesheet" href="{% static 'AdminLTE-3.2.0/plugins/fontawesome-free/css/all.min.css' %}">
  <link rel="stylesheet" href="{% static 'AdminLTE-3.2.0/dist/css/adminlte.min.css' %}">

  <!-- Custom Styles -->
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
      --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      --border-radius: 15px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    .main-header {
      background: var(--primary-gradient);
      border-bottom: none;
    }

    .main-sidebar {
      background: linear-gradient(180deg, #343a40 0%, #495057 100%);
    }

    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .upload-zone:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .upload-zone.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .upload-icon {
      font-size: 4rem;
      color: #667eea;
      margin-bottom: 20px;
    }

    .btn-upload {
      background: var(--primary-gradient);
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: var(--border-radius);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-upload:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .prediction-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }

    .prediction-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .result-good {
      background: var(--success-gradient);
      color: white;
    }

    .result-anomaly {
      background: var(--danger-gradient);
      color: white;
    }

    .confidence-bar {
      height: 10px;
      background: #e9ecef;
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }

    .confidence-fill {
      height: 100%;
      background: var(--success-gradient);
      transition: width 0.3s ease;
    }

    .confidence-fill.anomaly {
      background: var(--danger-gradient);
    }

    .preview-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .stats-card {
      text-align: center;
      padding: 25px;
      margin-bottom: 20px;
      border-radius: var(--border-radius);
    }

    .stats-card .stats-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .stats-card .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stats-card .stats-label {
      color: #6c757d;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stats-card.success {
      background: var(--success-gradient);
      color: white;
    }

    .stats-card.danger {
      background: var(--danger-gradient);
      color: white;
    }

    .stats-card.info {
      background: var(--info-gradient);
      color: #333;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button">
            <i class="fas fa-bars"></i>
          </a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="/auth/dashboard/" class="nav-link">Accueil</a>
        </li>
      </ul>
    </nav>

    <!-- Main Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <a href="/auth/dashboard/" class="brand-link">
        <img src="{% static 'images/logo.png' %}" alt="Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
        <span class="brand-text font-weight-light">AI Energy</span>
      </a>

      <div class="sidebar">
        <div class="user-panel mt-3 pb-3 mb-3 d-flex flex-column align-items-center">
          <div class="image">
            <img src="{{ photo_url }}" class="img-circle elevation-2" alt="Photo de profil" width="60" height="60">
          </div>
          <div class="info text-white mt-2">
            <strong>{{ username }}</strong><br>
            <small class="text-muted">Analyste IA</small>
          </div>
        </div>

        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <li class="nav-item">
              <a href="/auth/dashboard/" class="nav-link">
                <i class="nav-icon fas fa-chart-pie"></i>
                <p>Dashboard</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/analyse-csv/" class="nav-link">
                <i class="nav-icon fas fa-upload"></i>
                <p>Uploader des donn√©es</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/auth/predict-xgb-page/" class="nav-link">
                <i class="nav-icon fas fa-bolt"></i>
                <p>Pr√©dictions</p>
                <span class="badge badge-warning right">AI</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/auth/anomaly-detect/" class="nav-link">
                <i class="nav-icon fas fa-exclamation-triangle"></i>
                <p>Anomaly Detect</p>
                <span class="badge badge-danger right">üîç</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/auth/image-upload/" class="nav-link active">
                <i class="nav-icon fas fa-camera"></i>
                <p>Pr√©diction Images</p>
                <span class="badge badge-success right">ML</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/auth/image-history/" class="nav-link">
                <i class="nav-icon fas fa-history"></i>
                <p>Historique Images</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/auth/profile/edit/" class="nav-link">
                <i class="nav-icon fas fa-user-edit"></i>
                <p>Profil</p>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Pr√©diction d'Images</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="/auth/dashboard/">Accueil</a></li>
                <li class="breadcrumb-item active">Pr√©diction Images</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">

          <!-- Upload Section -->
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>
                    Uploader une Image
                  </h3>
                </div>
                <div class="card-body">
                  <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                      <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Glissez votre image ici</h4>
                    <p class="text-muted mb-3">ou cliquez pour s√©lectionner un fichier</p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-upload" onclick="document.getElementById('imageInput').click()">
                      <i class="fas fa-folder-open mr-2"></i>
                      Choisir une image
                    </button>
                    <div class="mt-3">
                      <small class="text-muted">
                        Formats support√©s: JPG, PNG, GIF (max 10MB)
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats -->
            <div class="col-md-4">
              <div class="card stats-card success">
                <div class="stats-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-number">{{ recent_predictions|length }}</div>
                <div class="stats-label">Images Analys√©es</div>
              </div>
            </div>
          </div>

          <!-- Prediction Result -->
          <div class="row" id="resultSection" style="display: none;">
            <div class="col-12">
              <div class="card prediction-card" id="predictionCard">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-brain mr-2"></i>
                    R√©sultat de la Pr√©diction
                  </h3>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4 text-center">
                      <img id="previewImage" class="preview-image" src="" alt="Image upload√©e">
                    </div>
                    <div class="col-md-8">
                      <div id="predictionResult">
                        <!-- Le r√©sultat sera ins√©r√© ici par JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Predictions -->
          {% if recent_predictions %}
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-history mr-2"></i>
                    Pr√©dictions R√©centes
                  </h3>
                  <div class="card-tools">
                    <a href="/auth/image-history/" class="btn btn-sm btn-primary">
                      <i class="fas fa-eye mr-1"></i>
                      Voir tout l'historique
                    </a>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row">
                    {% for prediction in recent_predictions %}
                    <div class="col-md-6 col-lg-4 mb-3">
                      <div class="card prediction-card {% if prediction.is_anomaly %}result-anomaly{% else %}result-good{% endif %}">
                        <div class="card-body text-center">
                          <img src="{{ prediction.image.url }}" class="preview-image mb-3" alt="Pr√©diction">
                          <h5>{{ prediction.result_label }}</h5>
                          <div class="confidence-bar">
                            <div class="confidence-fill {% if prediction.is_anomaly %}anomaly{% endif %}" 
                                 style="width: {{ prediction.confidence_percentage }}%"></div>
                          </div>
                          <p class="mb-1"><strong>{{ prediction.confidence_percentage }}%</strong> de confiance</p>
                          <small>{{ prediction.uploaded_at|date:"d/m/Y H:i" }}</small>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
      <strong>Copyright &copy; 2025 <a href="#">SFM Technologies</a>.</strong>
      Tous droits r√©serv√©s.
      <div class="float-right d-none d-sm-inline-block">
        <b>Version</b> 1.0.0
      </div>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="{% static 'AdminLTE-3.2.0/plugins/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'AdminLTE-3.2.0/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'AdminLTE-3.2.0/dist/js/adminlte.min.js' %}"></script>

  <script>
    $(document).ready(function() {
      const uploadZone = $('#uploadZone');
      const imageInput = $('#imageInput');
      const resultSection = $('#resultSection');
      const predictionCard = $('#predictionCard');
      const previewImage = $('#previewImage');
      const predictionResult = $('#predictionResult');

      // Click handler for upload zone
      uploadZone.on('click', function() {
        imageInput.click();
      });

      // Drag and drop handlers
      uploadZone.on('dragover', function(e) {
        e.preventDefault();
        uploadZone.addClass('dragover');
      });

      uploadZone.on('dragleave', function(e) {
        e.preventDefault();
        uploadZone.removeClass('dragover');
      });

      uploadZone.on('drop', function(e) {
        e.preventDefault();
        uploadZone.removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
          handleImageUpload(files[0]);
        }
      });

      // File input change handler
      imageInput.on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          handleImageUpload(file);
        }
      });

      function handleImageUpload(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Veuillez s√©lectionner un fichier image valide.');
          return;
        }

        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('Le fichier est trop volumineux (max 10MB).');
          return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.attr('src', e.target.result);
          resultSection.show();
          predictionCard.removeClass('result-good result-anomaly');
          
          // Show loading state
          predictionResult.html(`
            <div class="text-center">
              <div class="loading-spinner"></div>
              <h4 class="mt-3">Analyse en cours...</h4>
              <p class="text-muted">Le mod√®le d'IA traite votre image</p>
            </div>
          `);
        };
        reader.readAsDataURL(file);

        // Upload and predict
        const formData = new FormData();
        formData.append('image', file);

        $.ajax({
          url: '/auth/api/image-predict/',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            if (response.status === 'success') {
              displayPredictionResult(response.prediction);
            } else {
              displayError(response.error || 'Erreur inconnue');
            }
          },
          error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur de connexion';
            displayError(error);
          }
        });
      }

      function displayPredictionResult(prediction) {
        const isAnomaly = prediction.is_anomaly;
        const cardClass = isAnomaly ? 'result-anomaly' : 'result-good';
        const icon = isAnomaly ? 'fas fa-exclamation-triangle' : 'fas fa-check-circle';
        const color = isAnomaly ? '#ff4b2b' : '#00f2fe';

        predictionCard.addClass(cardClass);

        predictionResult.html(`
          <div class="text-center">
            <div style="font-size: 4rem; color: ${color}; margin-bottom: 20px;">
              <i class="${icon}"></i>
            </div>
            <h2 class="mb-3">${prediction.label}</h2>
            <div class="confidence-bar" style="max-width: 300px; margin: 0 auto;">
              <div class="confidence-fill ${isAnomaly ? 'anomaly' : ''}" 
                   style="width: ${prediction.confidence_percentage}%"></div>
            </div>
            <h4 class="mt-3">${prediction.confidence_percentage}% de confiance</h4>
            <p class="text-muted">Pr√©diction effectu√©e le ${prediction.uploaded_at}</p>
            <div class="mt-4">
              <button class="btn btn-secondary" onclick="resetUpload()">
                <i class="fas fa-redo mr-2"></i>
                Analyser une autre image
              </button>
              <a href="/auth/image-history/" class="btn btn-primary ml-2">
                <i class="fas fa-history mr-2"></i>
                Voir l'historique
              </a>
            </div>
          </div>
        `);
      }

      function displayError(error) {
        predictionResult.html(`
          <div class="text-center">
            <div style="font-size: 4rem; color: #ff4b2b; margin-bottom: 20px;">
              <i class="fas fa-times-circle"></i>
            </div>
            <h3 class="text-danger">Erreur</h3>
            <p class="text-muted">${error}</p>
            <button class="btn btn-secondary mt-3" onclick="resetUpload()">
              <i class="fas fa-redo mr-2"></i>
              R√©essayer
            </button>
          </div>
        `);
      }

      // Reset upload function
      window.resetUpload = function() {
        resultSection.hide();
        imageInput.val('');
        predictionCard.removeClass('result-good result-anomaly');
      };
    });
  </script>
</body>
</html>
